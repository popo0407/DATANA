### 【フェーズ2：実装（承認後） - 技術的制約と実装ルール】

**ユーザーから「OK」または修正の指示があった場合のみ、以下の厳格なルールに基づいてコード生成を行ってください。**

#### 【UI/UXとデザイン実装の絶対厳守事項 (Update Requirements)】
**以下のデザイン・挙動仕様を「変更不可の制約」として遵守してください。独自の改善や省略は一切禁止します。**

1.  **初期画面 (Splash Screen) の実装:**
    * アプリ起動時（ファイル未選択時）は、ヘッダーやダッシュボード、KPIなどの要素を**全て非表示 (`display: none`)** にしてください。
    * 画面中央に「**Majin Analytics**」というタイトルと、大きな「データ分析を開始する (CSV読込)」ボタンのみを表示するスプラッシュスクリーンを実装してください。
    * ファイルを読み込んだ後にのみ、スプラッシュスクリーンを非表示にし、ヘッダーとメインコンテンツを表示する仕様にしてください。

2.  **コンパクトヘッダーの採用:**
    * ヘッダー内にはアプリタイトルやアイコンを表示せず、**高さの低い1行のレイアウト**で構成してください。
    * 配置要素: CSV読込ボタン、PDF保存ボタン、フィルタ群、レイアウト切替ボタンのみ。
    * **APIキー入力欄は作成しないでください**（コード内の定数 `apiKey` を使用するためUIには不要）。

3.  **数値の短縮表示 (Smart Formatting):**
    * KPIパネル、グラフのデータラベル、**およびグラフのX/Y軸の目盛り**において、5桁以上の数値は必ず「1.2億」「3500万」のように単位付きで短縮表示する `formatShortNumber` 関数を実装・適用してください。そのままの桁数で表示することは禁止します。

4.  **デザインコードの完全維持 (Strict Design Compliance):**
    * **【参考：成功コードパターン】** で提供されるHTML/CSS構造、配色、Tailwindのクラス設定は、**一字一句変更せずそのまま採用**してください。
    * 「デザインを良くしました」等の理由で勝手にレイアウトやスタイルを変更することは固く禁じます。

#### 【AI分析レポート生成の拡張要件】
**Gemini APIに送信するプロンプトと、結果の表示処理において以下を遵守してください。**

1.  **レポート構成比率の指定:**
    * AIへの指示プロンプト内で、「**データの傾向分析（約7割）**」と「**戦略インサイト・提言（約3割）**」の比率で構成するよう明記してください。
    * ただし、生成されたセクションタイトル（見出し）には「（70%）」などの**割合数値を絶対に含めない**よう指示してください。

2.  **Markdown解析の強化 (Robust Parsing):**
    * AIには「強調表示（`**`）の前後に必ず半角スペースを入れる」よう指示し、パーサーの誤認を防いでください。
    * JavaScript側では `marked.parse()` の実行後に、変換漏れした `**text**` を正規表現で `<strong>text</strong>` に強制置換するフォールバック処理を必ず実装してください。


#### 1. 技術スタックと堅牢な環境構築 (Robust Technical Stack)
* **Single HTML Architecture:** ビルドエラーや環境依存を避けるため、Node.jsやReactビルド環境を使用せず、**「外部ライブラリをCDN経由で読み込む単一のHTMLファイル」**として出力してください。
* **Reliable CDN & Order:** ライブラリは必ず `jsdelivr` などの信頼性の高いCDNを使用し、以下の順序で `<head>` 内で読み込んでください。
    1.  **Tailwind CSS** (スタイリング)
    2.  **Chart.js** (グラフ描画 - ECharts/ApexChartsは使用禁止)
    3.  **Chart.js Plugin Datalabels**
    4.  **PapaParse** (CSVパース)
    5.  **jspdf** & **html2canvas** (PDF出力)
    6.  **Lucide Icons**
    7.  **Marked** (または自作のMarkdownパーサー関数)
* **Dependency Guard:** スクリプト実行時、`if (typeof Papa === 'undefined')` のようなチェックを行い、ライブラリが未ロードの場合は処理を中断してユーザーにアラートを出すガード処理を実装してください。
* **Container Constraint:** 画面幅が広がりすぎてレイアウトが崩れるのを防ぐため、`body` またはメインラッパーには必ず `.app-container { max-width: 1200px; margin: 0 auto; }` を適用し、中央揃えの固定幅レイアウトを強制してください。また、`overflow-x: hidden` を設定し、横スクロールを完全に防止してください。

#### 2. データ処理・クレンジングの厳格化 (Aggressive Data Cleansing)
* **BOM Removal:** Excel等で保存されたCSVに含まれる制御文字（BOM）を除去するため、読み込み直後のテキストに対し必ず `text.replace(/^\uFEFF/, '')` を実行してください。
* **Aggressive Number Parsing:** 数値変換において、単なる `parseFloat` は禁止します。必ず **正規表現 `/[^-0-9.]/g` を用いて、カンマ(`,`)、円記号(`¥` `円`)、引用符(`"`)、全角数字などの非数値文字をすべて除去** した上で数値化する共通関数 `cleanNum` を実装してください。
* **NaN & Null Safety:** データ欠損や計算不能な値（NaN/Infinity）が発生した場合、アプリケーションをクラッシュさせず、デフォルト値（`0` または `null`）を返す安全装置を組み込んでください。
* **Header Normalization:** ヘッダー行（カラム名）の前後に含まれる予期せぬ空白は、オブジェクトキーとして使用する前に必ず `trim()` で削除してください。
* **Encoding Retry Logic:** CSV読み込み時は、まず `Shift_JIS` での解析を試みてください。その後、解析結果のヘッダーに意味のある日本語（または期待されるキーワード）が含まれていない場合（文字化け判定）は、自動的に `UTF-8` で再読み込みを行う再帰的なロジックを必ず実装してください。
* **Header Flexibility (重要):** CSVのヘッダー名が完全に一致しない場合でもデータを取り込めるよう、主要な数値カラムのマッピングには必ず `OR` 演算子を使用したフォールバック処理を実装してください。
    * *悪い例:* `const sales = row['売上'];`
    * *必須実装:* `const sales = cleanNum(row['売上'] || row['売上額'] || row['契約金額'] || row['Sales']);`
* **Deep Column Mapping (重要):** データの取り込み漏れを防ぐため、重要項目については表記揺れや類似名を網羅的に検索してマッピングしてください。全角カナと半角カナ等
* **Keyword Precedence (包含単語の優先順位):**
    * 性別（Male/Female）やカテゴリ名において、**一方の単語が他方の単語に含まれるキーワード**が存在する場合は、必ず**「より長い（限定的な）単語」を先に判定**するロジックを実装してください。
    * 短い単語を先に判定して誤検知すること（False Positive）を避けるためです。
    * *悪い例:* `if (str.includes('Male'))` -> `Female` も `Male` として誤判定される。
    * *必須実装:* `if (str.match(/Female|女/i)) { ... } else if (str.match(/Male|男/i)) { ... }` のように、長い単語を優先して評価する順序を厳守してください。


#### 3. グラフ描画ロジックと軸の最適化 (Chart.js Optimization)
* **Scale Separation:** 円グラフ・ドーナツ・レーダー・極座標グラフの場合は、不要なグリッド線が表示されないよう、**X/Y軸（Cartesian scales）の設定を定義しない**条件分岐を実装してください。棒グラフや折れ線グラフの場合のみ `scales` オプションを適用してください。
* **High Cardinality Handling:** 項目数が12を超える集計（支店名など）では、自動的に**「上位10件＋その他」**に集約するロジック（`aggregateTopN`）をデフォルトで組み込み、凡例によるグラフの圧迫を回避してください。
* **Data Labels:** 全てのグラフで `chartjs-plugin-datalabels` を有効化し、グラフ内に数値を表示してください。
* **Formatter Safety (Crash Prevention):** ツールチップやデータラベルの `formatter` 関数内では、値が `null` または `undefined` の状態で `toLocaleString()` を呼ぶとアプリがクラッシュします。必ず関数の冒頭に `if (value == null) return '';` というガード処理を記述してください。
* **Chronological Sort:** 時系列データは必ず昇順（古い順）にソートしてください。
* **Smart Aggregation Logic (重要):**
    * **Ranking vs Share:** 「TOP10ランキング」等の順位比較グラフでは、ロングテールによるグラフの圧迫を防ぐため、集計関数で**「その他」カテゴリを生成せず除外**してください。一方、円グラフ（構成比）では「その他」を含めてください。
    * **Valid Average:** 平均値（顧客評価など）を計算する際は、未入力や0の値を分母に含めず、**有効値（>0）のみ**で計算するロジックを実装してください。
* **Dynamic Scales:** Y軸の最小値（min）を固定（例: 3以上）することは禁止します。データの実数に合わせてChart.jsが自動調整するようにし、データが見えなくなる不具合を防いでください。
* **Combo Chart Contrast (複合グラフの配色・視認性確保):**
    * 棒グラフ(Bar)と折れ線グラフ(Line)を組み合わせる「複合グラフ」においては、同系色（例: 青と水色）の使用を厳禁とします。
    * 視認性を確保するため、必ず**「寒色系（青・緑）」と「暖色系（オレンジ・赤）」のような明確な対比色（コントラスト）**を使用してください。
    * *必須実装:* 棒グラフにはメインカラー（例: `COLORS[0]` 青）、折れ線グラフにはアクセントカラー（例: `COLORS[7]` オレンジ）を明示的に割り当て、グラフの種類ごとに色相を大きく離すこと。


#### 4. 高度なUI/UXとレイアウト制御 (Layout & UI Standards)
* **Sticky Header with Controls:** ヘッダーは画面上部に固定（sticky）し、以下の要素を配置してください。
    * ファイル操作: CSV読込ボタン / PDF出力ボタン / **JSON保存ボタン（必須）**
    * フィルター群（エリア、地域、カテゴリ、期間など）フィルターは複数項目を選択できるように考慮してください。
    * **Layout Toggle (必須):** 「1列表示（詳細モード）」と「2列表示（一覧モード）」を切り替えるトグルボタンを実装してください。
* **Dynamic Chart Height:** レイアウトモードに応じて、グラフコンテナの高さを動的に変更するCSSクラス（例: `.cols-1 { height: 420px; }`, `.cols-2 { height: 280px; }`）を実装してください。
* **Pie Chart Stability:** 円グラフやドーナツグラフは、凡例（Legend）が増えてもグラフ本体が潰れないよう、凡例を右側に配置するか、アスペクト比を維持する設定を行ってください。
* **Auto Unit Conversion:** KPIや軸の数値は、「1.2億」「500万」のように日本語単位に短縮表示する `formatShortNumber` 関数を実装し、桁あふれを防止してください。
* **Space Efficiency:** アプリタイトルなどの装飾的な要素は最小限にし、分析グリッドの面積を最大化してください。
* **Refined KPI Design:** KPIカードのデザインは、間延びを防ぐために余白を詰め（`p-3`）、アイコンサイズを適度な大きさ（`w-12 h-12`程度）に調整して、スリムで情報の密度が高い洗練された見た目にしてください。

#### 5. AIインサイトの制御と表示 (AI Integration & Exact Strings)
* **Immutable API Key Declaration:** APIキーの定義行は、**一字一句変更せず、以下のコードをそのまま出力してください。** いかなるプレースホルダー（`YOUR_KEY`等）や環境変数（`process.env`等）も使用禁止です。
    * `const apiKey = ""; // APIキーは実行環境から提供されます`
* **Model Specification (CRITICAL):** 使用するモデルは **`gemini-2.5-flash-preview-09-2025`** です。APIリクエストのURLには必ずこの**正確なバージョン文字列**を使用してください。短縮形の `gemini-2.5-flash` や `gemini-pro` は動作しないため使用禁止です。
* **Robust Retry Logic:** API呼び出し時は、通信エラーだけでなく**レスポンスの中身（candidates配列やtextの欠損）も検証**してください。不正なレスポンスの場合もエラーとみなし、**最大3回まで指数バックオフ**（例: 1秒, 2秒, 4秒待機）を用いてリトライする堅牢なフェッチ関数を実装してください。
* **Robust Markdown Parser (必須):** AIからの回答（Markdown形式）をそのまま表示することは厳禁です。必ず **`marked.js` ライブラリ** を使用してHTMLに変換してください。単純な文字列置換ではなく、ライブラリのパーサーを通すことで、複雑なテーブルやネストされたリストを正しく描画させます。
* **Professional Styling:** AI出力エリア（`.prose-ai`）に対し、以下のCSSスタイル定義を義務付けます。
    * **Table:** `border-collapse: collapse; width: 100%;` とし、`th`, `td` には `border: 1px solid #e2e8f0; padding: 0.8rem;` を適用してExcelのような表形式で表示する。
    * **Striped Rows:** 表の視認性を高めるため、偶数行の背景色を変える（`tr:nth-child(even) { background: #f9fafb; }`）。
    * **Typography:** 見出し（h2, h3）には下線やアイコン装飾を施し、ビジネスレポートとしての体裁を整える。
* **Micro-Insights:** 各グラフカード内に「AIインサイトボックス」を設け、そのグラフ専用の分析コメントを**40文字程度の1文**で表示してください。
* **Global Summary:** ページ最下部に、データ全体の総括レポートを表示するセクションを設けてください。

#### 6. エクスポート機能の拡充と最適化 (PDF & JSON)
* **Lightweight PDF (Compression):** `html2canvas` と `jsPDF` を使用し、画像形式は必ず **JPEG（品質 0.75）** を指定して、ファイルサイズを劇的に（数MB程度に）軽量化してください。PNGは使用禁止です。
* **Strict Page Layout (レイアウト制御):**
    * **1ページ目:** タイトル + KPIパネル + **グラフ2個** が収まるように配置。
    * **2ページ目以降:** **グラフ3個** ずつ均等に配置。
    * **Bottom Margin:** ページ下部には必ず **10mm** の余白を確保し、グラフの見切れを完全に防いでください。
* **Element-Based Pagination:** ページ区切りで画像が切断されないよう、グラフやカード要素単位で高さを計算して改ページしてください。
* **AI Report Separation & Smart Slicing:**
    * AI分析レポートは、グラフ出力終了後の **新しいページから開始** してください。
    * レポートが複数ページにまたがる場合は、文字が行の途中で切断されないよう、Canvasのピクセルデータを解析して **空白行（文字がないライン）を検知して分割するスマートスライシング** ロジックを実装してください。
* **Print Styles:** PDF出力時のみ、AIレポート内の強調表示（背景色マーカー）やステータスアイコン（Thinking.../Completed）を非表示にする処理を実装してください。
* **JSON Export (Structured Data):** PDFボタンの横に「JSON保存」ボタンを設置し、現在のフィルタ条件、KPI数値、および全グラフの集計済みデータ（ラベル・値）を含む構造化データを一括ダウンロードできる機能を実装してください。

#### 7. ロジックの安全性とエラーガード (Logic Safety)
* **Error Isolation:** 万が一特定のグラフ集計でエラーが発生しても、他のグラフの描画を止めないよう、各グラフの生成ロジックを個別の `try-catch` ブロックで保護してください。
* **Variable Safety:** `reduce` や `map` 内で使用する集計変数は必ずスコープ内で初期化し、`ReferenceError` を防いでください。
* **Empty State:** データが存在しない場合の表示を実装してください。

### 【最終品質保証プロセス：要件漏れの完全防止】

コードを生成する直前に、以下の**「コンプライアンス・チェックリスト」**を内部的に実行し、すべての項目が `TRUE` であることを確認してください。

1.  [ ] **Architecture:** 単一HTMLか？ CDNの読み込み順序とガード処理は適切か？
2.  [ ] **Graph Count:** グラフ数が20個以上あるか？
3.  [ ] **Layout Control:** `.app-container` (max-w-1200px) で横スクロールを防いでいるか？
4.  [ ] **Layout Toggle:** 1列/2列の切り替えボタンと、高さの動的変更(`height: 420px/280px`)は実装されているか？
5.  [ ] **Data Safety:** 正規表現 `/[^-0-9.]/g` による強力な数値クリーニングとNaN対策はあるか？包含関係のある単語（Female/Male）の判定順序（長い単語が先） は守られているか？
6.  [ ] **AI Rendering:** MarkdownをHTMLに変換するパーサーと、見やすいCSSスタイル(`prose-ai`)は適用されているか？
7.  [ ] **Library:** Chart.jsを使用しているか？ (ECharts/ApexChartsは不可)
8.  [ ] **Format:** 数値は「万」「億」表記になっているか？
9.  [ ] **Cardinality:** 上位10件＋その他への集約ロジック(`aggregateTopN`)はあるか？
10. [ ] **PDF:** JPEG圧縮による軽量化とページ分割に対応しているか？
11. [ ] **Exact Match:** APIキー定義は `const apiKey = "";` と完全一致しているか？（`process.env`等は不使用か？）
